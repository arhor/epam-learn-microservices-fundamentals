version: "3.8"

services:
  ########## application services ##########

  discovery-service:
    container_name: discovery-service
    hostname: discovery-service
    build:
      context: app-discovery-service
    image: discovery-service:latest
    networks:
      - docker-network

  gateway-service:
    container_name: gateway-service
    hostname: gateway-service
    ports:
      - "8080:8080"
    expose:
      - "8080"
    build:
      context: app-gateway-service
    image: gateway-service:latest
    networks:
      - docker-network
    depends_on:
      - discovery-service
    env_file:
      - app-gateway-service/.env.local

  resource-processor:
    container_name: resource-processor
    hostname: resource-processor
    build:
      context: app-resource-processor
    image: resource-processor:latest
    networks:
      - docker-network
    depends_on:
      - localstack
      - discovery-service
      - resource-service
      - song-service
    env_file:
      - app-resource-processor/.env.local

  resource-service:
    container_name: resource-service
    hostname: resource-service
    build:
      context: app-resource-service
    image: resource-service:latest
    networks:
      - docker-network
    depends_on:
      - localstack
      - resource-service-db
      - discovery-service
      - storage-service
    env_file:
      - app-resource-service/.env.local

  song-service:
    container_name: song-service
    hostname: song-service
    build:
      context: app-song-service
    image: song-service:latest
    networks:
      - docker-network
    depends_on:
      - song-service-db
      - discovery-service
    env_file:
      - app-song-service/.env.local

  storage-service:
    container_name: storage-service
    hostname: storage-service
    build:
      context: app-storage-service
    image: storage-service:latest
    networks:
      - docker-network
    depends_on:
      - storage-service-db
      - discovery-service
    env_file:
      - app-storage-service/.env.local

  ########## databases required by services ##########

  resource-service-db:
    image: postgres:12
    container_name: resource-service-db
    networks:
      - docker-network
    tmpfs:
      - "/var/lib/postgresql/data"
    env_file:
      - app-resource-service/.env.local
    command: -p 5433

  song-service-db:
    image: postgres:12
    container_name: song-service-db
    networks:
      - "docker-network"
    tmpfs:
      - "/var/lib/postgresql/data"
    env_file:
      - "app-song-service/.env.local"
    command: -p 5434

  storage-service-db:
    image: postgres:12
    container_name: storage-service-db
    networks:
      - "docker-network"
    tmpfs:
      - "/var/lib/postgresql/data"
    env_file:
      - "app-storage-service/.env.local"
    command: -p 5435

  ########## AWS services emulation ##########

  localstack:
    image: localstack/localstack:latest
    container_name: localstack
    hostname: localstack
    expose:
      - "4566-4583"
    ports:
      - "4566-4583:4566-4583"
    networks:
      - docker-network
    volumes:
      - ${TEMPDIR:-/tmp/localstack}:/tmp/localstack
      - /var/run/docker.sock:/var/run/docker.sock
      - ./scripts/localstack:/docker-entrypoint-initaws.d/
    env_file:
      - app-resource-service/.env.local
    environment:
      SERVICES: s3,sqs

networks:
  docker-network:
    external:
      name: docker-network
